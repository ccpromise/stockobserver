
const getMktEqud = require('../sysApi').getMktEqud;
const time = require('utility').time;

module.exports = function (secID, beginDate, endDate) {
    var today = time.format(time.today(), 'YYYYMMDD')
    beginDate = beginDate || '19900101';
    endDate = endDate || today;
    return getMktEqud({ secID: secID, beginDate: beginDate, endDate: endDate }).then((r) => {
        if(r.retCode !== 1) return Promise.reject(new Error(r.retMsg));
        var minDay = today;
        var maxDay = '19900101';
        var tradeData = r.data.reduce((pre, cur) => {
            var date = time.format(cur.tradeDate, 'YYYYMMDD');
            minDay = time.isAfter(date, minDay) ? minDay : date;
            maxDay = time.isAfter(maxDay, date) ? maxDay : date;

            var stock = Object.create(null), adjFactor = cur.accumAdjFactor / r.data[0].accumAdjFactor;
            stock.o = cur.openPrice * adjFactor;
            stock.e = cur.closePrice * adjFactor;
            stock.h = cur.highestPrice * adjFactor;
            stock.l = cur.lowestPrice * adjFactor;
            stock.x = cur.turnoverRate;
            stock.v = cur.turnoverVol;
            pre[date] = stock;
            return pre;
        }, {});
        return {
            data: tradeData,
            minDay: minDay,
            maxDay: maxDay,
            preClosePrice: r.data[0].preClosePrice
        };
    })
}
