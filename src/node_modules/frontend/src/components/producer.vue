<template>
    <div class="col-12 mt20">
        <select v-model="task">
          <option disabled value="">Please select a task</option>
          <option value="simulate">simulate</option>
          <option value="updateStockData">update stock data</option>
      </select>
        <div class="col-12 mt20">
            <p>Total: {{secIDList.length}}</p>
            <textarea v-model="input" rows="8" cols="80" placeholder="use ; to seperate secID"></textarea>
            <template v-show="task === 'simulate'">
                <p>Tradeplan Id</p>
                <input type="text" v-model="tradeplanId">
            </template>
        </div>
        <div class="col-12 mt20">
            <span class="btn btn-danger small" type="button" v-on:click="reset">Reset</span>
            <span class="btn small" type="button" v-on:click="submit" v-bind:disabled="secIDList.length === 0">Submit</span>
            <span>{{result}}</span>
        </div>
    </div>
</template>

<script>
    const taskStatus = require('usrConstants').taskStatus;

    module.exports = {
        props: ['httpRequest'],
        data: function () {
            return {
                task: 'simulate',
                tradeplanId: 'MA1060',
                input: '',
                result: ''
            }
        },
        computed: {
            secIDList: function () {
                var list = this.input.split(/[\s\t\n;]+/);
                return list.filter((ele) => ele !== '').map((secID) => { return secID.toLowerCase(); });
            },
            data: function () {
                return {
                    docs: this.secIDList.map((secID) => {
                        return {
                            task: {
                                type: this.task,
                                pack: this.task === 'simulate' ? { tradeplanId: this.tradeplanId, secID: secID } : secID
                            },
                            status: taskStatus.ready,
                            log: [{
                                desc: 'build new ready task',
                                time: new Date().toISOString(),
                                err: null
                            }]
                        }
                    })
                }
            },
            //* readonly
            path: function () {
                return '/task';
            },
            //* readyonly
            verb: function () {
                return 'insertMany';
            }
        },
        methods: {
            reset: function () {
                this.input = '';
                this.result = '';
                this.tradeplanId = 'MA1060';
            },
            submit: function () {
                this.httpRequest(this.path, this.data, this.verb, (r) => {
                    this.result = r instanceof Error ? 'fail' : 'success';
                });
            }
        }
    }
</script>

<style lang="css">
</style>