<template>
    <div class="col-12 mt20">
        <div class="col-12">
            <div class="col-12">
                <span class="w150">stock id:</span>
                <input type="text" v-model="filter.secID">
            </div>
            <div class="col-12 mt5">
                <span class="w150">trade plan:</span>
                <input type="text" v-model="filter.tradeplanId">
            </div>
            <div class="col-12 mt5">
                <span class="w150">state:</span>
                <input type="radio" value="all" v-model="filter.closed" />all
                <input type="radio" value="closed" v-model="filter.closed" />closed
                <input type="radio" value="open" v-model="filter.closed" />open
            </div>
        </div>
        <div class="col-12 mt20">
            <span class="btn small" type="button" v-on:click="search()">Search</span>
            <span class="btn small btn-danger" type="button" v-on:click="clearSearch()">Clear</span>
        </div>
        <div class="col-12 mt20">
            <span class="btn small" type="button" v-on:click="selectPage(1)" v-bind:disabled="currentPage === 1 || totalPage === 0"><<</span>
            <span class="btn small" type="button" v-on:click="selectPage(currentPage-1)" v-bind:disabled="currentPage === 1 || totalPage === 0"><</span>
            <span>{{currentPage}} / {{totalPage}}</span>
            <span class="btn small" type="button" v-on:click="selectPage(currentPage+1)" v-bind:disabled="currentPage === totalPage || totalPage === 0">></span>
            <span class="btn small" type="button" v-on:click="selectPage(totalPage)" v-bind:disabled="currentPage === totalPage || totalPage === 0">>></span>
        </div>
        <div class="col-12 mt20">
            <table class="col-12" style="text-align: left">
                <tr>
                    <th><span v-on:click="sortBy('secID')" v-bind:style="{ color: (sortKey === 'secID' ? 'green' : 'black')}">Stock Id</span></th>
                    <th><span>Closed</span></th>
                    <th><span v-on:click="sortBy('st')" v-bind:style="{ color: (sortKey === 'st' ? 'green' : 'black')}">Start Date</span></th>
                    <th><span>Start Price</span></th>
                    <th><span>LatestDate/EndDate</span></th>
                    <th><span>LatestPrice/EndPrice</span></th>
                    <th><span>Trade Plan</span></th>
                </tr>
                <tr v-for="item in paginatedItems">
                    <td>{{item.secID}}</td>
                    <td>{{item.closed}}</td>
                    <td>{{item.st | formatTs}}</td>
                    <td>{{item.sp | numeral}}</td>
                    <td>{{item.et | formatTs}}</td>
                    <td>{{item.ep | numeral}}</td>
                    <td>{{item.tradeplanId}}</td>
                </tr>
            </table>
        </div>
    </div>
</template>

<script>
    module.exports = {
        props: ['httpRequest'],
        data: function () {
            return {
                filter: {
                    secID: '',
                    tradeplanId: '',
                    closed: 'all'
                },
                totalItems: 0,
                paginatedItems: [],
                sortKey: 'st',
                order: -1,
                pageSize: 10,
                currentPage: 0
            }
        },
        filters: {
            formatTs: function (dateTs) {
                return new Date(dateTs * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);
            },
            numeral: function (num) {
                return num.toFixed(2);
            }
        },
        computed: {
            totalPage: function () {
                return Math.ceil(this.totalItems / this.pageSize);
            },
            sort: function () {
                var res = Object.create(null);
                res[this.sortKey] = this.order;
                return res;
            },
            path: function () {
                return '/simulate';
            },
            verb: function () {
                return 'getMul';
            }
        },
        methods: {
            data: function (page) {
                var filter = {};
                if (this.filter.secID) filter.secID = this.filter.secID.toLowerCase();
                if (this.filter.tradeplanId) filter.tradeplanId = this.filter.tradeplanId;
                if (this.filter.closed === 'closed') filter.closed = true;
                if (this.filter.closed === 'open') filter.closed = false;
                return {
                    pageNum: page,
                    pageSize: this.pageSize,
                    filter: filter,
                    sort: this.sort
                }
            },
            selectPage: function (page) {
                this.httpRequest(this.path, this.data(Math.max(1, page)), this.verb, (r) => {
                    var res = r instanceof Error ? {
                        pageNum: 0,
                        pageSize: this.pageSize,
                        total: 0,
                        data: []
                    } : JSON.parse(r);
                    this.currentPage = res.pageNum;
                    this.pageSize = res.pageSize;
                    this.totalItems = res.total;
                    this.paginatedItems = res.data;
                })
            },
            search: function () {
                this.selectPage(1);
            },
            clearSearch: function () {
                this.filter.secID = '';
                this.filter.closed = 'all';
                this.filter.tradeplanId = '';
                this.selectPage(1);
            },
            update: function () {
                this.selectPage(this.currentPage);
            },
            sortBy: function (key) {
                if (key === this.sortKey) this.order = -this.order;
                else {
                    this.sortKey = key;
                    this.order = 1;
                }
                this.selectPage(this.currentPage);
            }
        },
        mounted: function () {
            this.selectPage(1);
        }
    }
</script>
