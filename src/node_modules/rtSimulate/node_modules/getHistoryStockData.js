
const utility = require('utility');
const makeDataPvd = require('dataPvd');
const plans = require('tradeplans');
const getStockList = require('getStockList');
const parallelN = 10;

/**
 * for each trade plan, prepare the history stock data for real time simulation.
 */
module.exports = function(planIds) {
    return getStockList().then((list) => {
        var i = 0, N = list.length;

        return utility.async.parallel(() => {
            return i < N;
        }, () => {
            var secID = list[i++];
            console.log('get history stock data for secID: ', secID, i);
            return makeDataPvd({ type: 'end', pack: secID }).then((end) => {
                // for all trade plans, get history data using secID's end pvd
                return Promise.all(planIds.map((id) => {
                    return plans[id].getHistoryStockData(secID, end);
                }))
            }).catch((err) => {
                console.log('find err when getting history stock data ', secID, ': ', err);
            })
        }, parallelN);
    });
}
