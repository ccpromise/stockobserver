
const simulate = require('./simulate');
const makeDataPvd = require('dataPvd');
const utility = require('utility');
const time = utility.time;
const object = utility.object;
const id = 'MA1060';

var ma9 = new Map();
var ma10 = new Map();
var ma59 = new Map();
var ma60 = new Map();
var endPrice = new Map();
var dts;

/**
 * end: data pvd
 * set the ma9, ma10, ma59, ma60, endPrice for secID based on end
 */
exports.getHistoryStockData = function (secID, end) {
    dts = time.getDateTs(time.today());
    return Promise.all([9, 10, 59, 60].map((N) => {
        return makeDataPvd({ type: 'ma', pack: { pvd: end, N: N } });
    })).then((pvds) => {
        var maxTs = end.maxTs;
        if(pvds[3].hasDef(maxTs)) {
            endPrice.set(secID, end.get(maxTs));
            ma9.set(secID, pvds[0].get(maxTs));
            ma10.set(secID, pvds[1].get(maxTs));
            ma59.set(secID, pvds[2].get(maxTs));
            ma60.set(secID, pvds[3].get(maxTs));
        }
    });
}

exports.simulate = function (trades, rtdata) {
    return simulate(trades, rtdata, dts, endPrice, buy, sell, id);
}

function buy(secID, price) {
    return ma10.get(secID) < ma60.get(secID) && (ma9.get(secID) * 9 + price) / 10 > (ma59.get(secID) * 59 + price) / 60;
}

function sell(secID, price) {
    return ma10.get(secID) > ma60.get(secID) && (ma9.get(secID) * 9 + price) / 10 < (ma59.get(secID) * 59 + price) / 60;
}
